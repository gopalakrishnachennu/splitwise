rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users: each user can read/write ONLY their own document.
    // Admins (users/{uid}.role == 'admin') and the hard-coded owner email
    // can read & write all users for the admin panel.
    match /users/{userId} {
      // Regular user: only own document
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Admin / Owner: any user document (including others)
      allow read, write: if request.auth != null
        && (
          // Admins by role field on their own user doc
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
          // Hard-coded owner email has full admin rights
          || request.auth.token.email == 'gopalakrishnachennu@gmail.com'
        );
    }

    // App data: authenticated read/write. Tighten by membership/ownership if needed.
    match /friends/{id} { allow read, write: if request.auth != null; }
    match /groups/{id} { allow read, write: if request.auth != null; }
    match /expenses/{id} { allow read, write: if request.auth != null; }
    match /activities/{id} { allow read, write: if request.auth != null; }
    match /settlements/{id} { allow read, write: if request.auth != null; }

    // Global config (e.g. maintenance mode)
    match /config/{docId} {
      // All clients (even unauthenticated) can read maintenance config
      allow read: if true;

      // Only admins / owners can write config
      allow write: if request.auth != null
        && (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
          || request.auth.token.email == 'gopalakrishnachennu@gmail.com'
          || request.auth.token.email == 'gopalakrishnachennu.dev@gmail.com'
        );
    }
  }
}
